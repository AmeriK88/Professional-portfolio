{% extends "base.html" %}
{% load static %}
{% block title %}Iniciar sesión{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-md-6 col-lg-4">
    <h1 class="h3 mb-3">Iniciar sesión</h1>

    {% if PI_ONLY_LOGIN %}
      <div class="alert alert-info">
        Durante la revisión del Core Team, el acceso es <strong>solo con Pi</strong>.
      </div>

      <button class="btn btn-primary w-100" type="button" onclick="loginWithPi()">
        Iniciar sesión con Pi
      </button>

      <div class="mt-3 small text-muted">
        ¿Problemas? Abre esta app desde <strong>Pi Browser</strong> y vuelve a intentarlo.
      </div>

    {% else %}
      <form id="login-form" method="post" novalidate>
        {% csrf_token %}
        {{ form.non_field_errors }}

        <div class="mb-3">
          <label class="form-label">Usuario</label>
          {{ form.username }}
        </div>
        <div class="mb-3">
          <label class="form-label">Contraseña</label>
          {{ form.password }}
        </div>

        <!-- reCAPTCHA v3 -->
        {{ form.recaptcha_token }}

        <button class="btn btn-primary w-100" type="submit">Entrar</button>
      </form>

      <!-- Aviso reCAPTCHA -->
      <div class="mt-3">
        <div class="d-flex align-items-start gap-2 small text-muted border rounded-3 p-3 bg-light">
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true" class="mt-1">
            <path d="M12 2l7 3v6c0 5-3.8 9.7-7 11-3.2-1.3-7-6-7-11V5l7-3z" fill="currentColor" opacity=".15"></path>
            <path d="M12 2l7 3v6c0 5-3.8 9.7-7 11-3.2-1.3-7-6-7-11V5l7-3zm0 2.2L7 5.3v5.6c0 3.9 2.8 8 5 9.3 2.2-1.3 5-5.4 5-9.3V5.3l-5-1.1zM10.9 14.6l-2.1-2.1 1.4-1.4 1.4 1.4 3.3-3.3 1.4 1.4-4.7 4.7z" fill="currentColor"></path>
          </svg>
          <div>
            <div class="fw-semibold">Protección activa con Google reCAPTCHA v3</div>
            <div>
              Esta página está protegida por reCAPTCHA y se aplican la
              <a class="link-secondary" href="https://policies.google.com/privacy" target="_blank" rel="noopener noreferrer">Política de Privacidad</a>
              y los
              <a class="link-secondary" href="https://policies.google.com/terms" target="_blank" rel="noopener noreferrer">Términos de Servicio</a>
              de Google.
            </div>
          </div>
        </div>
      </div>

      <!-- Acciones de cuenta -->
      <div class="mt-3">
        <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2 border rounded-3 p-3">
          <div class="d-flex align-items-center gap-2">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M15 14c2.8 0 5 2.2 5 5v1H4v-1c0-2.8 2.2-5 5-5h6zM9 5a4 4 0 118 0 4 4 0 01-8 0z" fill="currentColor" opacity=".15"></path>
              <path d="M12 13c3.3 0 6 2.7 6 6v1H6v-1c0-3.3 2.7-6 6-6zm0-10a4 4 0 110 8 4 4 0 010-8zM20 7h-2V5h-2V3h2V1h2v2h2v2h-2v2z" fill="currentColor"></path>
            </svg>
            <span class="small">¿Sin cuenta?</span>
            <a class="btn btn-sm btn-outline-primary"
               href="{% url 'users:register' %}{% if request.GET.next %}?next={{ request.GET.next }}{% endif %}">
              Regístrate
            </a>
          </div>
          <div>
            <a class="small link-primary" href="{% url 'users:password_reset' %}">
              ¿Olvidaste tu contraseña?
            </a>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
  {% if not PI_ONLY_LOGIN %}
    <script src="https://www.google.com/recaptcha/api.js?render={{ RECAPTCHA_SITE_KEY }}"></script>
    <script src="{% static 'js/recaptcha-login.js' %}"></script>
  {% endif %}

  <script>
    // Inicializa el SDK (sandbox=true mientras pruebas en el Sandbox)
    if (window.Pi) {
      Pi.init({ version: "2.0", sandbox: true });
    } else {
      console.error("Pi SDK no disponible");
    }

    function getCsrf(name="csrftoken"){
      return document.cookie.split('; ').find(r=>r.startsWith(name+'='))?.split('=')[1];
    }

    async function loginWithPi(){
      try{
        if (!window.Pi) throw new Error("Pi SDK no cargado");
        const { accessToken } = await Pi.authenticate(['username','payments']);
        const resp = await fetch("{% url 'users:pi_login' %}", {
          method: "POST",
          headers: {"Content-Type":"application/json", "X-CSRFToken": getCsrf()},
          body: JSON.stringify({ accessToken })
        });
        if(!resp.ok){
          const t = await resp.text().catch(()=> "");
          throw new Error("pi_login falló: " + (t || resp.status));
        }
        const next = new URLSearchParams(window.location.search).get("next");
        window.location = next || "{% url 'users:profile' %}";
      }catch(e){
        console.error(e);
        alert("No se pudo iniciar sesión con Pi. Revisa:\n• Estás en Pi Browser\n• Pi.init() ejecutado\n• Sandbox autorizado hoy");
      }
    }
  </script>

{% endblock %}
