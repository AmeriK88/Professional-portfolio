{% extends "base.html" %}
{% block content %}
<div class="container py-5">
  <h1>Acceso solo con Pi</h1>
  <p class="text-muted">Durante la revisión del Core Team, el inicio de sesión y registro se hacen únicamente con Pi.</p>
  <button class="btn btn-primary" onclick="loginWithPi()">Iniciar sesión con Pi</button>
</div>

<script src="https://downloads.minepi.com/sdk/v1/prod.js"></script>
<script>
  function getCsrf(n="csrftoken"){
    return document.cookie.split('; ').find(v=>v.startsWith(n+'='))?.split('=')[1]
  }
  async function loginWithPi(){
    try{
      const { accessToken } = await Pi.authenticate(['username','payments']);
      const r = await fetch("{% url 'users:pi_login' %}", {
        method: "POST",
        headers: {"Content-Type":"application/json","X-CSRFToken":getCsrf()},
        body: JSON.stringify({ accessToken })
      });
      if(!r.ok) throw new Error("Login Pi falló");
      window.location = "{% url 'users:profile' %}";
    }catch(e){
      alert("No se pudo iniciar sesión con Pi"); console.error(e);
    }
  }
</script>
{% endblock %}
