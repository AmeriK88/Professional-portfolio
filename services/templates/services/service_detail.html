{% extends "base.html" %}
{% load static %}

{% block title %}{{ service.title }}{% endblock %}

{% block content %}
<div class="container py-5">

  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{% url 'services:service_list' %}">Servicios</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        {{ service.title }}
      </li>
    </ol>
  </nav>

  <h1 class="mb-3">{{ service.title }}</h1>
  <p class="text-muted mb-4">Desde <strong>{{ service.price }} €</strong></p>

  {# Media preview #}
  {% if service.preview %}
    {% if service.preview.url|lower|slice:"-4:" == ".mp4" %}
      <video
        src="{{ service.preview.url }}"
        class="w-100 rounded mb-4"
        autoplay muted loop playsinline preload="metadata"
        {% if service.image %}poster="{{ service.image.url }}"{% endif %}>
        Tu navegador no soporta vídeo.
      </video>
    {% else %}
      <img src="{{ service.preview.url }}"
           class="img-fluid rounded mb-4"
           alt="{{ service.title }}">
    {% endif %}
  {% elif service.image %}
    <img src="{{ service.image.url }}"
         class="img-fluid rounded mb-4"
         alt="{{ service.title }}">
  {% endif %}

  {# 1) Descripción #}
  <section class="mb-5">
    <h2 class="h4">Descripción</h2>
    <div class="lead">
      {{ service.description|linebreaks }}
    </div>
  </section>

  {# 2) Características #}
  {% if service.features.exists %}
    <section class="mb-5">
      <h2 class="h4">Lo que incluye este servicio</h2>
      <ul class="list-unstyled ps-3">
        {% for feat in service.features.all %}
          <li>✅ {{ feat.text|linebreaksbr }}</li>
        {% endfor %}
      </ul>
    </section>
  {% endif %}

  {# --- CTA --- #}
  <div class="d-flex gap-2 mb-5">
    <a href="{% url 'services:service_list' %}" class="btn btn-outline-secondary">
      ← Volver
    </a>

  {% if request.user.is_authenticated %}
    <button
      id="pi-pay-btn"
      class="btn btn-primary"
      data-checkout-url="{% url 'orders:checkout_service' service.slug %}">
      Pagar con
      <img src="{% static 'images/pi-icon.svg' %}" alt="Pi" class="pi-icon" width="18" height="18">
    </button>
  {% else %}
    <a class="btn btn-primary" href="{% url 'users:login' %}?next={{ request.get_full_path }}">
      Iniciar sesión para pagar
    </a>
  {% endif %}
  </div>


  {# 4) FAQs #}
  {% if service.faqs.exists %}
    <h2 class="h4 mb-3">Preguntas frecuentes</h2>
    <div class="accordion mb-5" id="faqAccordion">
      {% for faq in service.faqs.all %}
        <div class="accordion-item">
          <h2 class="accordion-header" id="q{{ forloop.counter }}">
            <button class="accordion-button collapsed" type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#a{{ forloop.counter }}"
                    aria-expanded="false"
                    aria-controls="a{{ forloop.counter }}">
              {{ faq.question }}
            </button>
          </h2>
          <div id="a{{ forloop.counter }}"
               class="accordion-collapse collapse"
               data-bs-parent="#faqAccordion">
            <div class="accordion-body">
              {{ faq.answer|linebreaks }}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {# 5) JSON-LD #}
  {% if service.faqs.exists %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {% for faq in service.faqs.all %}
        {
          "@type": "Question",
          "name": {{ faq.question|escapejs }},
          "acceptedAnswer": {
            "@type": "Answer",
            "text": {{ faq.answer|linebreaksbr|escapejs }}
          }
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ]
    }
    </script>
  {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js" defer></script>

  <!-- Config para el JS estático -->
  <script>
    window.PI_CFG = {
      sandbox: true,  // pon false cuando pases a real
      approveUrl: "{% url 'pi:approve' %}",
      completeUrl: "{% url 'pi:complete' %}",
      cancelUrl: "{% url 'pi:cancel' %}",
      successUrl: "{% url 'services:payment_success' %}"
    };
  </script>

  <!-- Manejador -->
  <script src="{% static 'js/pi_payments.js' %}" defer></script>
{% endblock %}

